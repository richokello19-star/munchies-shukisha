<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ===== ENHANCED SEO META TAGS ===== -->
    <title>Munchies & Shukisha | Kenya's Local Chef Marketplace - Order Food Delivery</title>
    <meta name="description" content="Order authentic local cuisine from home chefs & restaurants in Kenya. Fast food delivery with Munchies & Shukisha - Every bite's a party!">
    <meta name="keywords" content="food delivery kenya, local chefs, restaurants nairobi, order food online, home cooked meals, munchies shukisha, kenyan food">
    <meta name="author" content="Munchies & Shukisha">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Munchies & Shukisha | Kenya's Local Chef Marketplace">
    <meta property="og:description" content="Order authentic local cuisine from home chefs & restaurants in Kenya. Fast delivery - Every bite's a party!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://munchiesandshukisha.netlify.app">
    <meta property="og:image" content="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Munchies & Shukisha">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Munchies & Shukisha | Kenya's Local Chef Marketplace">
    <meta name="twitter:description" content="Order authentic local cuisine from home chefs & restaurants in Kenya">
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80">
    
    <!-- Additional Important Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#11151C">
    <meta name="msapplication-TileColor" content="#11151C">
    
    <!-- Mobile-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Munchies & Shukisha">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://munchiesandshukisha.netlify.app">
    
    <!-- Structured Data / Schema.org -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FoodEstablishment",
      "name": "Munchies & Shukisha",
      "description": "Kenya's Local Chef Marketplace - Order from home chefs & restaurants near you",
      "url": "https://munchiesandshukisha.netlify.app",
      "image": "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "KE"
      },
      "servesCuisine": ["Kenyan", "African", "Local Cuisine"],
      "priceRange": "$$"
    }
    </script>

    <!-- ===== PERFORMANCE OPTIMIZATIONS ===== -->
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- DNS prefetch for external domains -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://images.unsplash.com">
    
    <!-- Preconnect to critical origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Favicon improvements -->
    <link rel="icon" href="munchies-logo.png" type="image/png">
    <link rel="apple-touch-icon" href="munchies-logo.png">
    
    <!-- Existing styles and fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <!-- ===== ACCESSIBILITY: SKIP TO CONTENT ===== -->
    <a href="#main-content" class="skip-to-content" aria-label="Skip to main content">Skip to Content</a>

    <header role="banner">
        <div class="header-content">
            <div class="logo-container">
                <div class="logo">
                    <div class="logo-icon" aria-hidden="true">
                        <img src="munchies-logo.png" alt="Munchies Logo" onerror="this.style.display='none'">
                    </div>
                    <span>Munchies & Shukisha</span>
                </div>
                <div class="brand-names" aria-label="Tagline: Every bite's a party">
                    <span>Every bite's a party</span>
                </div>
            </div>
            <nav role="navigation" aria-label="Main navigation">
                <ul>
                    <li><a href="#" aria-current="page"><i class="fas fa-home" aria-hidden="true"></i> <span class="nav-text">Home</span></a></li>
                    <li><a href="#vendors"><i class="fas fa-utensils" aria-hidden="true"></i> <span class="nav-text">Vendors</span></a></li>
                    <li><a href="#features"><i class="fas fa-star" aria-hidden="true"></i> <span class="nav-text">Features</span></a></li>
                    <li id="authItem"><a href="#" id="authLink"><i class="fas fa-user" aria-hidden="true"></i> <span class="nav-text">Login</span></a></li>
                    <li id="vendorDashboardLink" style="display: none;"><a href="vendor-dashboard.html"><i class="fas fa-store" aria-hidden="true"></i> <span class="nav-text">My Store</span></a></li>
                    <li><a href="#" onclick="showContactModal(); return false;"><i class="fas fa-phone" aria-hidden="true"></i> <span class="nav-text">Contact</span></a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main id="main-content" role="main">
        <!-- Home page content (default view) -->
        <div id="home-page">
            <section class="hero" aria-label="Welcome to Munchies & Shukisha">
                <div class="hero-content">
                    <h1>Kenya's Local Chef Marketplace</h1>
                    <p>Order from home chefs & restaurants near you</p>
                    <div class="btn-container">
                        <a href="#vendors" class="btn" aria-label="Browse our food vendors">Browse Vendors</a>
                        <a href="#" class="btn btn-secondary" onclick="showSignupModal(); return false;" aria-label="Sign up to sell your food">Sell Your Food</a>
                    </div>
                </div>
            </section>
            
            <section class="features" id="features" aria-labelledby="features-heading">
                <h2 id="features-heading">Why Choose Munchies & Shukisha?</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon" aria-hidden="true">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <h3>Authentic Local Cuisine</h3>
                        <p>Discover the best home-cooked meals from talented chefs in your neighborhood, offering authentic flavors you can't find anywhere else.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon" aria-hidden="true">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <h3>Fast Delivery</h3>
                        <p>Get your favorite meals delivered to your doorstep in under 30 minutes with our efficient delivery network.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon" aria-hidden="true">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Quality Assured</h3>
                        <p>All our vendors are verified and regularly inspected to ensure the highest standards of food safety and quality.</p>
                    </div>
                </div>
            </section>
            
            <section class="menu" id="vendors" aria-labelledby="vendors-heading">
                <div class="menu-header">
                    <h2 id="vendors-heading">Featured Vendors</h2>
                    <p>Discover amazing home chefs and restaurants in your area</p>
                </div>

                <!-- Search and Filter System -->
                <div class="search-filter-container">
                    <div class="search-section">
                        <div class="search-input-container">
                            <input type="text" id="searchInput" class="search-input" placeholder="Search for vendors, dishes, or cuisines..." aria-label="Search for vendors, dishes, or cuisines">
                            <i class="fas fa-search search-icon" aria-hidden="true"></i>
                        </div>
                        <button class="filter-toggle" id="filterToggle" aria-expanded="false" aria-controls="filterSection">
                            <i class="fas fa-filter" aria-hidden="true"></i>
                            Filters
                        </button>
                    </div>

                    <div class="filter-section" id="filterSection" role="region" aria-labelledby="filterToggle">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label class="filter-label" for="cuisineFilter">Cuisine Type</label>
                                <select id="cuisineFilter" class="filter-select">
                                    <option value="">All Cuisines</option>
                                    <option value="kenyan">Kenyan</option>
                                    <option value="african">African</option>
                                    <option value="indian">Indian</option>
                                    <option value="chinese">Chinese</option>
                                    <option value="italian">Italian</option>
                                    <option value="american">American</option>
                                    <option value="mexican">Mexican</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="priceFilter">Price Range</label>
                                <select id="priceFilter" class="filter-select">
                                    <option value="">Any Price</option>
                                    <option value="budget">Budget (Under KSh 300)</option>
                                    <option value="moderate">Moderate (KSh 300 - 700)</option>
                                    <option value="premium">Premium (Over KSh 700)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="ratingFilter">Minimum Rating</label>
                                <select id="ratingFilter" class="filter-select">
                                    <option value="">Any Rating</option>
                                    <option value="4.5">4.5+ Stars</option>
                                    <option value="4.0">4.0+ Stars</option>
                                    <option value="3.5">3.5+ Stars</option>
                                    <option value="3.0">3.0+ Stars</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="deliveryFilter">Delivery Time</label>
                                <select id="deliveryFilter" class="filter-select">
                                    <option value="">Any Time</option>
                                    <option value="fast">Fast (Under 30 min)</option>
                                    <option value="standard">Standard (30-45 min)</option>
                                    <option value="extended">Extended (45+ min)</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn filter-apply" id="applyFilters" aria-label="Apply filters">Apply Filters</button>
                            <button class="filter-btn filter-reset" id="resetFilters" aria-label="Reset all filters">Reset</button>
                        </div>
                    </div>

                    <div class="results-info">
                        <div class="results-count" id="resultsCount" aria-live="polite">Showing all vendors</div>
                        <div class="sort-options">
                            <span class="sort-label">Sort by:</span>
                            <select id="sortOptions" class="sort-select" aria-label="Sort vendors by">
                                <option value="name">Name (A-Z)</option>
                                <option value="rating">Highest Rated</option>
                                <option value="delivery">Fastest Delivery</option>
                                <option value="price-low">Price (Low to High)</option>
                                <option value="price-high">Price (High to Low)</option>
                            </select>
                        </div>
                    </div>

                    <div class="active-filters" id="activeFilters" aria-live="polite">
                        <!-- Active filters will be displayed here -->
                    </div>
                </div>

                <div class="menu-items" id="vendors-container">
                    <!-- Vendor items will be dynamically populated here -->
                    <div class="empty-state">
                        <i class="fas fa-utensils" aria-hidden="true"></i>
                        <h3>No Vendors Yet</h3>
                        <p>Be the first to sign up as a vendor and showcase your culinary creations!</p>
                        <button class="btn" onclick="showSignupModal()" style="margin-top: 20px;" aria-label="Become a food vendor">Become a Vendor</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Restaurant Detail Page (hidden by default) -->
        <div id="restaurant-detail-page" class="restaurant-detail" style="display: none;" aria-hidden="true">
            <!-- Content will be dynamically populated by JavaScript -->
        </div>
    </main>

    <!-- Contact Modal -->
    <div class="auth-modal" id="contactModal" aria-hidden="true" role="dialog" aria-labelledby="contact-heading">
        <span class="close" onclick="closeContactModal()" aria-label="Close contact modal">×</span>
        <div class="contact-container">
            <div class="contact-header">
                <h2 id="contact-heading">Get In Touch</h2>
                <p>We'd love to hear from you! Reach out through any of these channels.</p>
            </div>
            
            <div class="contact-content">
                <!-- Contact Info -->
                <div class="contact-info">
                    <h3>Contact Information</h3>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Phone Numbers</h4>
                            <p>+254 113 110 743 (M-Pesa & WhatsApp)</p>
                            <p>Call us for any inquiries or support</p>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Email Address</h4>
                            <p>richokello19@gmail.com</p>
                            <p>support@munchiesandshukisha.com</p>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Business Location</h4>
                            <p>Nairobi, Kenya</p>
                            <p>Serving customers across Kenya</p>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Business Hours</h4>
                            <p>Monday - Sunday: 7:00 AM - 11:00 PM</p>
                            <p>24/7 Customer Support Available</p>
                        </div>
                    </div>

                    <div class="contact-social">
                        <h4>Follow Us</h4>
                        <div class="social-links">
                            <a href="https://facebook.com/munchiesandshukisha" class="social-link" target="_blank" rel="noopener">
                                <i class="fab fa-facebook-f"></i>
                                <span>Facebook</span>
                            </a>
                            <a href="https://instagram.com/munchiesandshukisha" class="social-link" target="_blank" rel="noopener">
                                <i class="fab fa-instagram"></i>
                                <span>Instagram</span>
                            </a>
                            <a href="https://tiktok.com/@munchiesandshukisha" class="social-link" target="_blank" rel="noopener">
                                <i class="fab fa-tiktok"></i>
                                <span>TikTok</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Contact Form -->
                <div class="contact-form">
                    <h3>Send us a Message</h3>
                    <form id="contactModalForm">
                        <div class="form-group">
                            <label for="contactModalName">Full Name</label>
                            <input type="text" id="contactModalName" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contactModalEmail">Email Address</label>
                            <input type="email" id="contactModalEmail" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contactModalSubject">Subject</label>
                            <input type="text" id="contactModalSubject" name="subject" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contactModalMessage">Message</label>
                            <textarea id="contactModalMessage" name="message" required></textarea>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Float Button -->
    <div class="whatsapp-float" onclick="openWhatsApp()" role="button" aria-label="Contact us on WhatsApp">
        <i class="fab fa-whatsapp" aria-hidden="true"></i>
    </div>

    <!-- Protected Content Overlay -->
    <div class="protected-overlay" id="protectedOverlay" aria-hidden="true">
        <div class="protected-content">
            <h2>Please Sign In</h2>
            <p>You need to be logged in to make purchases</p>
            <button onclick="showLoginModal()" class="btn" aria-label="Open login modal">Login</button>
            <p>Don't have an account? <a href="#" onclick="showSignupModal()" aria-label="Open signup modal">Sign up</a></p>
        </div>
    </div>

    <!-- Shopping Cart -->
    <div class="cart-icon" onclick="showCart()" role="button" aria-label="View shopping cart" tabindex="0">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        <div class="cart-count" id="cartCount" aria-live="polite">0</div>
    </div>

    <!-- Auth Modals -->
    <div class="overlay" id="overlay" aria-hidden="true"></div>
    
    <div class="auth-modal" id="loginModal" aria-hidden="true" role="dialog" aria-labelledby="login-heading">
        <span class="close" onclick="closeAllModals()" aria-label="Close login modal">×</span>
        <div class="auth-header">
            <div class="auth-icon" aria-hidden="true">
                <i class="fas fa-user"></i>
            </div>
            <h2 id="login-heading">Welcome Back</h2>
            <p>Sign in to your account to continue</p>
        </div>
        
        <div class="form-input-group">
            <input type="email" id="loginEmail" placeholder=" " autocomplete="email" aria-required="true" aria-describedby="loginEmailError">
            <label for="loginEmail">Email Address</label>
            <div class="form-error" id="loginEmailError" role="alert">Please enter a valid email address</div>
        </div>
        
        <div class="form-input-group">
            <input type="password" id="loginPassword" placeholder=" " autocomplete="current-password" aria-required="true" aria-describedby="loginPasswordError">
            <label for="loginPassword">Password</label>
            <span class="password-toggle" id="loginPasswordToggle" role="button" aria-label="Toggle password visibility">
                <i class="fas fa-eye"></i>
            </span>
            <div class="form-error" id="loginPasswordError" role="alert">Please enter your password</div>
        </div>
        
        <div class="remember-forgot">
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Remember me</label>
            </div>
            <a href="#" class="forgot-password" onclick="showForgotPassword(); return false;" aria-label="Reset your password">Forgot password?</a>
        </div>
        
        <button id="loginButton" onclick="handleLogin()" aria-label="Sign in to your account">Login</button>
        
        <div class="divider">
            <span>Or continue with</span>
        </div>
        
        <div class="social-login">
            <button class="social-btn google" onclick="signInWithGoogle()" aria-label="Sign in with Google">
                <i class="fab fa-google"></i>
                Google
            </button>
            <button class="social-btn facebook" onclick="signInWithFacebook()" aria-label="Sign in with Facebook">
                <i class="fab fa-facebook-f"></i>
                Facebook
            </button>
        </div>
        
        <div class="auth-footer">
            Don't have an account? <a onclick="switchToSignup()" aria-label="Switch to signup form">Sign up</a>
        </div>
    </div>
    
    <div class="auth-modal" id="signupModal" aria-hidden="true" role="dialog" aria-labelledby="signup-heading">
        <span class="close" onclick="closeAllModals()" aria-label="Close signup modal">×</span>
        <div class="auth-header">
            <div class="auth-icon" aria-hidden="true">
                <i class="fas fa-user-plus"></i>
            </div>
            <h2 id="signup-heading">Create Account</h2>
            <p>Join our community of food lovers</p>
        </div>
        
        <div class="form-input-group">
            <input type="text" id="signupName" placeholder=" " autocomplete="name" aria-required="true" aria-describedby="signupNameError">
            <label for="signupName">Full Name</label>
            <div class="form-error" id="signupNameError" role="alert">Please enter your full name</div>
        </div>
        
        <div class="form-input-group">
            <input type="email" id="signupEmail" placeholder=" " autocomplete="email" aria-required="true" aria-describedby="signupEmailError">
            <label for="signupEmail">Email Address</label>
            <div class="form-error" id="signupEmailError" role="alert">Please enter a valid email address</div>
        </div>
        
        <div class="form-input-group">
            <input type="password" id="signupPassword" placeholder=" " autocomplete="new-password" aria-required="true" aria-describedby="signupPasswordError">
            <label for="signupPassword">Password</label>
            <span class="password-toggle" id="signupPasswordToggle" role="button" aria-label="Toggle password visibility">
                <i class="fas fa-eye"></i>
            </span>
            <div class="form-error" id="signupPasswordError" role="alert">Password must be at least 8 characters</div>
        </div>
        
        <div class="form-input-group">
            <select id="userType" onchange="toggleVendorFields()" aria-required="true" aria-describedby="userTypeError">
                <option value="buyer">I'm a Buyer</option>
                <option value="seller">I'm a Seller</option>
            </select>
            <div class="form-error" id="userTypeError" role="alert">Please select an account type</div>
        </div>
        
        <!-- Vendor-specific fields (hidden by default) -->
        <div id="vendorFields" aria-hidden="true">
            <div class="form-input-group">
                <input type="text" id="businessName" placeholder=" " autocomplete="organization" aria-required="true" aria-describedby="businessNameError">
                <label for="businessName">Business Name</label>
                <div class="form-error" id="businessNameError" role="alert">Please enter your business name</div>
            </div>
            
            <div class="form-input-group">
                <input type="text" id="businessLocation" placeholder=" " autocomplete="address-level2" aria-required="true" aria-describedby="businessLocationError">
                <label for="businessLocation">Business Location</label>
                <div class="form-error" id="businessLocationError" role="alert">Please enter your business location</div>
            </div>
            
            <div class="form-input-group">
                <input type="text" id="foodHandlersCert" placeholder=" " aria-required="true" aria-describedby="foodHandlersCertError">
                <label for="foodHandlersCert">Food Handler's Certificate No.</label>
                <div class="form-error" id="foodHandlersCertError" role="alert">Please enter your certificate number</div>
            </div>
            
            <div class="form-input-group">
                <input type="text" id="kraPin" placeholder=" " aria-required="true" aria-describedby="kraPinError">
                <label for="kraPin">KRA PIN</label>
                <div class="form-error" id="kraPinError" role="alert">Please enter your KRA PIN</div>
            </div>
            
            <div class="form-input-group">
                <textarea id="description" placeholder=" " rows="3" aria-required="true" aria-describedby="descriptionError"></textarea>
                <label for="description">Describe your food business</label>
                <div class="form-error" id="descriptionError" role="alert">Please describe your business</div>
            </div>
            
            <div class="file-upload-container">
                <label class="file-upload-label">Business Logo</label>
                <div class="file-upload-box" onclick="document.getElementById('businessLogo').click()" role="button" aria-label="Upload business logo">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    <p>Click to upload or drag and drop</p>
                    <span>PNG, JPG, GIF up to 10MB</span>
                    <input type="file" id="businessLogo" accept="image/*" onchange="previewImage(this, 'logoPreview')">
                </div>
                <div class="image-preview" id="logoPreview"></div>
            </div>
            
            <div class="file-upload-container">
                <label class="file-upload-label">Business Photos</label>
                <div class="file-upload-box" onclick="document.getElementById('businessPhotos').click()" role="button" aria-label="Upload business photos">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    <p>Click to upload or drag and drop</p>
                    <span>PNG, JPG, GIF up to 10MB</span>
                    <input type="file" id="businessPhotos" accept="image/*" multiple onchange="previewImage(this, 'photosPreview')">
                </div>
                <div class="image-preview" id="photosPreview"></div>
            </div>
            
            <div class="form-input-group">
                <select id="deliveryMethod" aria-required="true" aria-describedby="deliveryMethodError">
                    <option value="">Delivery Method</option>
                    <option value="self">Self-Delivery</option>
                    <option value="platform">Platform Delivery</option>
                    <option value="both">Both</option>
                </select>
                <div class="form-error" id="deliveryMethodError" role="alert">Please select a delivery method</div>
            </div>
            
            <div class="file-upload-container">
                <label class="file-upload-label">Business Permit</label>
                <div class="file-upload-box" onclick="document.getElementById('businessPermit').click()" role="button" aria-label="Upload business permit">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    <p>Click to upload your business permit</p>
                    <span>Image or PDF up to 10MB</span>
                    <input type="file" id="businessPermit" accept="image/*,.pdf">
                </div>
            </div>

            <!-- Subscription Payment Section -->
            <div class="payment-section">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Choose Your Subscription Plan</h3>
                
                <div class="subscription-plans">
                    <div class="subscription-plan">
                        <div class="plan-header">
                            <div class="plan-name">Basic</div>
                            <div class="plan-price">KSh 400</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check"></i> Up to 20 menu items</li>
                            <li><i class="fas fa-check"></i> Basic vendor profile</li>
                            <li><i class="fas fa-check"></i> Order management</li>
                            <li><i class="fas fa-check"></i> Customer reviews</li>
                            <li class="disabled"><i class="fas fa-times"></i> Premium placement</li>
                            <li class="disabled"><i class="fas fa-times"></i> Analytics dashboard</li>
                            <li class="disabled"><i class="fas fa-times"></i> Marketing tools</li>
                        </ul>
                        <button class="btn" onclick="selectPlan('basic', 400)" style="width: 100%;">Select Basic</button>
                    </div>
                    
                    <div class="subscription-plan popular">
                        <div class="plan-header">
                            <div class="plan-name">Professional</div>
                            <div class="plan-price">KSh 800</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check"></i> Up to 50 menu items</li>
                            <li><i class="fas fa-check"></i> Enhanced vendor profile</li>
                            <li><i class="fas fa-check"></i> Advanced order management</li>
                            <li><i class="fas fa-check"></i> Customer reviews & ratings</li>
                            <li><i class="fas fa-check"></i> Premium placement</li>
                            <li><i class="fas fa-check"></i> Basic analytics</li>
                            <li class="disabled"><i class="fas fa-times"></i> Advanced marketing</li>
                        </ul>
                        <button class="btn" onclick="selectPlan('professional', 800)" style="width: 100%; background: var(--secondary);">Select Professional</button>
                    </div>
                    
                    <div class="subscription-plan">
                        <div class="plan-header">
                            <div class="plan-name">Enterprise</div>
                            <div class="plan-price">KSh 1500</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check"></i> Unlimited menu items</li>
                            <li><i class="fas fa-check"></i> Premium vendor profile</li>
                            <li><i class="fas fa-check"></i> Complete order management</li>
                            <li><i class="fas fa-check"></i> Advanced review system</li>
                            <li><i class="fas fa-check"></i> Top placement priority</li>
                            <li><i class="fas fa-check"></i> Advanced analytics</li>
                            <li><i class="fas fa-check"></i> Marketing & promotion tools</li>
                        </ul>
                        <button class="btn" onclick="selectPlan('enterprise', 1500)" style="width: 100%;">Select Enterprise</button>
                    </div>
                </div>

                <div id="paymentSection" style="display: none;">
                    <h4 style="margin: 25px 0 15px; color: var(--primary);">Complete Your Payment</h4>
                    
                    <div class="payment-methods">
                        <div class="payment-method active" onclick="selectPaymentMethod('mpesa')">
                            <i class="fas fa-mobile-alt"></i>
                            <span>M-Pesa</span>
                        </div>
                    </div>

                    <div id="mpesaForm" class="mpesa-form active">
                        <div class="form-input-group">
                            <input type="tel" id="mpesaPhone" placeholder=" " aria-required="true" aria-describedby="mpesaPhoneError" value="0113110743">
                            <label for="mpesaPhone">M-Pesa Phone Number</label>
                            <div class="form-error" id="mpesaPhoneError" role="alert">Please enter your M-Pesa phone number</div>
                        </div>
                        <button class="btn" onclick="processMpesaPayment()" style="width: 100%; background: var(--success);">
                            <i class="fas fa-lock"></i> Pay with M-Pesa
                        </button>
                        <p style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9rem;">
                            Use phone number: <strong>0113110743</strong> for M-Pesa payments
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="remember-me">
            <input type="checkbox" id="termsAgree" aria-required="true">
            <label for="termsAgree">I agree to the <a href="#" style="color: var(--secondary);">Terms of Service</a> and <a href="#" style="color: var(--secondary);">Privacy Policy</a></label>
        </div>
        
        <button id="signupButton" onclick="handleSignup()" aria-label="Create your account">Create Account</button>
        
        <div class="divider">
            <span>Or sign up with</span>
        </div>
        
        <div class="social-login">
            <button class="social-btn google" onclick="signInWithGoogle()" aria-label="Sign up with Google">
                <i class="fab fa-google"></i>
                Google
            </button>
            <button class="social-btn facebook" onclick="signInWithFacebook()" aria-label="Sign up with Facebook">
                <i class="fab fa-facebook-f"></i>
                Facebook
            </button>
        </div>
        
        <div class="auth-footer">
            Already have an account? <a onclick="switchToLogin()" aria-label="Switch to login form">Login</a>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="auth-modal" id="forgotPasswordModal" aria-hidden="true" role="dialog" aria-labelledby="forgot-password-heading">
        <span class="close" onclick="closeAllModals()" aria-label="Close forgot password modal">×</span>
        <div class="auth-header">
            <div class="auth-icon" aria-hidden="true">
                <i class="fas fa-key"></i>
            </div>
            <h2 id="forgot-password-heading">Reset Password</h2>
            <p>Enter your email to receive a reset link</p>
        </div>
        
        <div class="form-input-group">
            <input type="email" id="resetEmail" placeholder=" " autocomplete="email" aria-required="true" aria-describedby="resetEmailError">
            <label for="resetEmail">Email Address</label>
            <div class="form-error" id="resetEmailError" role="alert">Please enter a valid email address</div>
        </div>
        
        <button id="resetPasswordButton" onclick="resetPassword()" aria-label="Send password reset instructions">Send Reset Link</button>
        
        <div class="auth-footer">
            Remember your password? <a onclick="switchToLogin()" aria-label="Switch to login form">Login</a>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkoutModal" aria-hidden="true" role="dialog" aria-labelledby="checkout-heading">
        <span class="close" onclick="closeCheckout()" aria-label="Close checkout modal">×</span>
        <h2 id="checkout-heading">Checkout</h2>
        <div class="checkout-items" id="checkoutItems">
            <!-- Cart items will be populated here -->
        </div>
        <div class="checkout-total">
            <span>Total:</span>
            <span id="checkoutTotal">KSh 0</span>
        </div>
        
        <div class="payment-form">
            <h3>Payment Method</h3>
            <div class="payment-options">
                <div class="payment-option active" onclick="selectPayment('mpesa')" role="button" aria-label="Pay with M-Pesa" tabindex="0">
                    <i class="fas fa-mobile-alt" aria-hidden="true"></i>
                    <span>M-Pesa</span>
                </div>
                <div class="payment-option" onclick="selectPayment('cash')" role="button" aria-label="Pay with cash" tabindex="0">
                    <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                    <span>Cash</span>
                </div>
            </div>
            
            <div id="mpesaForm">
                <div class="form-group">
                    <input type="tel" placeholder="Phone Number" id="mpesaPhoneCheckout" aria-label="M-Pesa phone number" value="0113110743">
                </div>
                <button onclick="payWithMpesa()" class="btn" aria-label="Complete payment with M-Pesa">Pay with M-Pesa</button>
            </div>
            
            <div id="cashForm" style="display: none;">
                <p>Pay with cash when your order is delivered</p>
                <button onclick="placeOrder()" class="btn" aria-label="Place order with cash payment">Place Order</button>
            </div>
        </div>
    </div>

    <footer role="contentinfo">
        <p>&copy; <span id="currentYear">2023</span> Munchies & Shukisha. All rights reserved.</p>
        <p style="margin-top: 10px; font-size: 0.9rem;">
            Contact: +254 113 110 743 | Email: richokello19@gmail.com
        </p>
        <!-- Social Icons moved to footer -->
        <div class="social-icons" aria-label="Social media links">
            <a href="https://facebook.com/munchiesandshukisha" title="Facebook" aria-label="Visit our Facebook page" target="_blank" rel="noopener"><i class="fab fa-facebook-f" aria-hidden="true"></i></a>
            <a href="https://instagram.com/munchiesandshukisha" title="Instagram" aria-label="Visit our Instagram page" target="_blank" rel="noopener"><i class="fab fa-instagram" aria-hidden="true"></i></a>
            <a href="https://tiktok.com/@munchiesandshukisha" title="TikTok" aria-label="Visit our TikTok page" target="_blank" rel="noopener"><i class="fab fa-tiktok" aria-hidden="true"></i></a>
            <a href="https://wa.me/254113110743" title="WhatsApp" aria-label="Contact us on WhatsApp" target="_blank" rel="noopener"><i class="fab fa-whatsapp" aria-hidden="true"></i></a>
        </div>
    </footer>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCNulf_lX3VcwmameFUvkAf3D6d5c8w5CA",
            authDomain: "munchies-and-shukisha.firebaseapp.com",
            projectId: "munchies-and-shukisha",
            storageBucket: "munchies-and-shukisha.firebasestorage.app",
            messagingSenderId: "349555107843",
            appId: "1:349555107843:web:2e23b5a31b460cb33c0636"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User logged in:', user.email);
                updateAuthUI(user);
                checkUserType(user.uid);
            } else {
                console.log('User logged out');
                updateAuthUI(null);
            }
        });

        // Update UI based on auth state
        function updateAuthUI(user) {
            const authLink = document.getElementById('authLink');
            const vendorDashboardLink = document.getElementById('vendorDashboardLink');
            
            if (user) {
                authLink.innerHTML = '<i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span>';
                authLink.onclick = logout;
                if (vendorDashboardLink) {
                    checkUserType(user.uid);
                }
            } else {
                authLink.innerHTML = '<i class="fas fa-user"></i> <span class="nav-text">Login</span>';
                authLink.onclick = showLoginModal;
                if (vendorDashboardLink) {
                    vendorDashboardLink.style.display = 'none';
                }
            }
        }

        // Check if user is a vendor
        async function checkUserType(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const vendorDashboardLink = document.getElementById('vendorDashboardLink');
                    if (userData.userType === 'seller' && vendorDashboardLink) {
                        vendorDashboardLink.style.display = 'list-item';
                    }
                }
            } catch (error) {
                console.error('Error checking user type:', error);
            }
        }

        // Firebase Authentication Functions
        async function login(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function signup(email, password, userData) {
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user data to Firestore
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    name: userData.name,
                    userType: userData.userType,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // If user is a seller, create vendor profile
                if (userData.userType === 'seller') {
                    await createVendorProfile(user.uid, userData);
                }
                
                return { success: true, user: user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function createVendorProfile(uid, userData) {
            try {
                await db.collection('vendors').doc(uid).set({
                    businessName: userData.businessName,
                    businessLocation: userData.businessLocation,
                    description: userData.description,
                    businessType: userData.businessType || 'Food Vendor',
                    owner: userData.email,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error creating vendor profile:', error);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showToast('Logged out successfully', false, 'success');
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error logging out', true);
            }
        }

        // ===== SUBSCRIPTION PAYMENT FUNCTIONS =====
        let selectedPlan = null;
        let selectedPlanPrice = 0;
        let selectedPaymentMethod = '';

        function selectPlan(plan, price) {
            selectedPlan = plan;
            selectedPlanPrice = price;
            
            // Show payment section
            document.getElementById('paymentSection').style.display = 'block';
            
            // Hide the regular signup button
            document.getElementById('signupButton').style.display = 'none';
            
            showToast(`Selected ${plan} plan - KSh ${price}/month`, false, 'success');
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.payment-method').classList.add('active');
            
            // Show appropriate form
            document.querySelectorAll('.mpesa-form, .card-form').forEach(el => {
                el.classList.remove('active');
            });
            
            if (method === 'mpesa') {
                document.getElementById('mpesaForm').classList.add('active');
            }
        }

        async function processMpesaPayment() {
            if (!selectedPlan) {
                showToast('Please select a subscription plan first', true);
                return;
            }

            const phone = document.getElementById('mpesaPhone').value;
            if (!phone) {
                showToast('Please enter your M-Pesa phone number', true);
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            button.disabled = true;

            try {
                // Simulate M-Pesa payment processing
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Create subscription record
                const user = auth.currentUser;
                if (user) {
                    await db.collection('subscriptions').doc(user.uid).set({
                        userId: user.uid,
                        plan: selectedPlan,
                        price: selectedPlanPrice,
                        status: 'active',
                        paymentMethod: 'mpesa',
                        mpesaPhone: phone,
                        startDate: firebase.firestore.FieldValue.serverTimestamp(),
                        endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Update vendor status to active
                    await db.collection('vendors').doc(user.uid).update({
                        status: 'active',
                        subscriptionPlan: selectedPlan
                    });
                }

                showToast('Payment successful! Your vendor account is now active.', false, 'success');
                closeAllModals();
                
                // Reset form
                resetPaymentForm();
                
            } catch (error) {
                console.error('Payment error:', error);
                showToast('Payment failed. Please try again.', true);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function resetPaymentForm() {
            selectedPlan = null;
            selectedPlanPrice = 0;
            selectedPaymentMethod = '';
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('signupButton').style.display = 'block';
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.mpesa-form, .card-form').forEach(el => {
                el.classList.remove('active');
            });
        }

        // ===== CONTACT FUNCTIONS =====
        function openWhatsApp() {
            const phone = '254113110743';
            const message = 'Hello Munchies & Shukisha! I would like to get more information about your services.';
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function submitContactForm(event) {
            event.preventDefault();
            
            const name = document.getElementById('contactModalName').value;
            const email = document.getElementById('contactModalEmail').value;
            const subject = document.getElementById('contactModalSubject').value;
            const message = document.getElementById('contactModalMessage').value;

            if (!name || !email || !subject || !message) {
                showToast('Please fill in all fields', true);
                return;
            }

            // Simulate form submission
            showToast('Message sent successfully! We will get back to you soon.', false, 'success');
            
            // Reset form
            document.getElementById('contactModalForm').reset();
        }

        // ADDED: Contact Modal Functions
        function showContactModal() {
            try {
                closeAllModals();
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('contactModal').style.display = 'block';
                document.getElementById('contactModal').setAttribute('aria-hidden', 'false');
            } catch (error) {
                console.error("Error showing contact modal:", error);
                showToast("Error opening contact form", true);
            }
        }

        function closeContactModal() {
            try {
                document.getElementById('contactModal').style.display = 'none';
                document.getElementById('contactModal').setAttribute('aria-hidden', 'true');
                document.getElementById('overlay').style.display = 'none';
            } catch (error) {
                console.error("Error closing contact modal:", error);
            }
        }

        // Export for use in other files
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.firebaseAuth = { login, signup, logout };

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // DOM Elements
        const authLink = document.getElementById('authLink');
        const authItem = document.getElementById('authItem');
        const overlay = document.getElementById('overlay');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const protectedOverlay = document.getElementById('protectedOverlay');
        const cartCount = document.getElementById('cartCount');
        const homePage = document.getElementById('home-page');
        const restaurantDetailPage = document.getElementById('restaurant-detail-page');
        const checkoutModal = document.getElementById('checkoutModal');
        const checkoutItems = document.getElementById('checkoutItems');
        const checkoutTotal = document.getElementById('checkoutTotal');
        const vendorsContainer = document.getElementById('vendors-container');
        const vendorDashboardLink = document.getElementById('vendorDashboardLink');

        // Search and Filter Elements
        const searchInput = document.getElementById('searchInput');
        const filterToggle = document.getElementById('filterToggle');
        const filterSection = document.getElementById('filterSection');
        const cuisineFilter = document.getElementById('cuisineFilter');
        const priceFilter = document.getElementById('priceFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const deliveryFilter = document.getElementById('deliveryFilter');
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');
        const resultsCount = document.getElementById('resultsCount');
        const sortOptions = document.getElementById('sortOptions');
        const activeFilters = document.getElementById('activeFilters');

        // Cart state
        let cart = [];
        let isLoggedIn = false;
        let currentUser = null;
        let vendors = [];

        // Search and Filter state
        let currentFilters = {
            search: '',
            cuisine: '',
            price: '',
            rating: '',
            delivery: ''
        };

        // Initialize the page
        function init() {
            loadCart();
            loadVendors();
            checkBackgroundColor();
            setupHeaderScroll();
            setupAuthEnhancements();
            setupSearchAndFilter();
            preloadCriticalImages();
            
            // Setup contact form
            document.getElementById('contactModalForm').addEventListener('submit', submitContactForm);
            
            // ===== ACCESSIBILITY: ENHANCE KEYBOARD NAVIGATION =====
            enhanceKeyboardNavigation();
        }

        // ===== SEARCH AND FILTER SYSTEM =====
        function setupSearchAndFilter() {
            // Toggle filter section
            filterToggle.addEventListener('click', function() {
                filterSection.classList.toggle('active');
                filterToggle.classList.toggle('active');
                filterToggle.setAttribute('aria-expanded', filterSection.classList.contains('active'));
            });

            // Apply filters
            applyFilters.addEventListener('click', applySearchAndFilter);

            // Reset filters
            resetFilters.addEventListener('click', resetSearchAndFilter);

            // Search input with debounce
            searchInput.addEventListener('input', debounce(function() {
                currentFilters.search = this.value;
                applySearchAndFilter();
            }, 300));

            // Sort options
            sortOptions.addEventListener('change', applySearchAndFilter);

            // Filter changes
            cuisineFilter.addEventListener('change', function() {
                currentFilters.cuisine = this.value;
                updateActiveFilters();
            });

            priceFilter.addEventListener('change', function() {
                currentFilters.price = this.value;
                updateActiveFilters();
            });

            ratingFilter.addEventListener('change', function() {
                currentFilters.rating = this.value;
                updateActiveFilters();
            });

            deliveryFilter.addEventListener('change', function() {
                currentFilters.delivery = this.value;
                updateActiveFilters();
            });
        }

        function applySearchAndFilter() {
            const filteredVendors = filterVendors();
            const sortedVendors = sortVendors(filteredVendors);
            renderFilteredVendors(sortedVendors);
            updateResultsCount(sortedVendors.length);
            updateActiveFilters();
        }

        function filterVendors() {
            return vendors.filter(vendor => {
                // Search filter
                if (currentFilters.search) {
                    const searchTerm = currentFilters.search.toLowerCase();
                    const matchesSearch = 
                        vendor.businessName.toLowerCase().includes(searchTerm) ||
                        vendor.description.toLowerCase().includes(searchTerm) ||
                        (vendor.cuisineType && vendor.cuisineType.toLowerCase().includes(searchTerm));
                    
                    if (!matchesSearch) return false;
                }

                // Cuisine filter
                if (currentFilters.cuisine && vendor.cuisineType !== currentFilters.cuisine) {
                    return false;
                }

                // Price filter
                if (currentFilters.price) {
                    const priceRange = getPriceRange(vendor);
                    if (priceRange !== currentFilters.price) return false;
                }

                // Rating filter
                if (currentFilters.rating) {
                    const minRating = parseFloat(currentFilters.rating);
                    if (vendor.rating < minRating) return false;
                }

                // Delivery filter
                if (currentFilters.delivery) {
                    const deliveryTime = getDeliveryTime(vendor);
                    if (deliveryTime !== currentFilters.delivery) return false;
                }

                return true;
            });
        }

        function sortVendors(vendors) {
            const sortBy = sortOptions.value;
            
            return [...vendors].sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.businessName.localeCompare(b.businessName);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'delivery':
                        return (a.deliveryTime || 45) - (b.deliveryTime || 45);
                    case 'price-low':
                        return (a.minPrice || 0) - (b.minPrice || 0);
                    case 'price-high':
                        return (b.minPrice || 0) - (a.minPrice || 0);
                    default:
                        return 0;
                }
            });
        }

        function renderFilteredVendors(filteredVendors) {
            if (filteredVendors.length === 0) {
                vendorsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search" aria-hidden="true"></i>
                        <h3>No vendors found</h3>
                        <p>Try adjusting your search or filters to find what you're looking for.</p>
                        <button class="btn" onclick="resetSearchAndFilter()" style="margin-top: 20px;" aria-label="Reset all filters">Reset Filters</button>
                    </div>
                `;
                return;
            }

            let vendorsHTML = '';
            
            filteredVendors.forEach(vendor => {
                vendorsHTML += `
                    <div class="menu-item" onclick="showRestaurantDetail('${vendor.id}')" role="button" tabindex="0" aria-label="View ${vendor.businessName} details">
                        <button class="add-to-cart" onclick="event.stopPropagation(); addToCart('${vendor.businessName} Sample Dish', 499)" aria-label="Add sample dish from ${vendor.businessName} to cart">
                            <i class="fas fa-plus" aria-hidden="true"></i>
                        </button>
                        <img src="${vendor.logo || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'}" alt="${vendor.businessName}" class="menu-item-img" loading="lazy">
                        <div class="menu-item-content">
                            <span class="vendor-badge">${vendor.businessType || 'Food Vendor'}</span>
                            <h3>${vendor.businessName}</h3>
                            <p>${vendor.description || 'Delicious food made with love and tradition.'}</p>
                            <div class="rating" aria-label="Rating: ${vendor.rating || 4} out of 5 stars">
                                ${generateStarRating(vendor.rating || 4)}
                                <span>(${vendor.reviewCount || 0} reviews)</span>
                            </div>
                            <p class="price">KSh ${vendor.minPrice || 499}+</p>
                            <button class="btn" onclick="event.stopPropagation(); addToCart('${vendor.businessName} Sample Dish', ${vendor.minPrice || 499})" aria-label="Add sample dish from ${vendor.businessName} to cart">Add to Cart</button>
                        </div>
                    </div>
                `;
            });
            
            vendorsContainer.innerHTML = vendorsHTML;
        }

        function generateStarRating(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star" aria-hidden="true"></i>';
            }
            
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt" aria-hidden="true"></i>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star" aria-hidden="true"></i>';
            }
            
            return stars;
        }

        function getPriceRange(vendor) {
            const price = vendor.minPrice || 499;
            if (price < 300) return 'budget';
            if (price <= 700) return 'moderate';
            return 'premium';
        }

        function getDeliveryTime(vendor) {
            const time = vendor.deliveryTime || 45;
            if (time < 30) return 'fast';
            if (time <= 45) return 'standard';
            return 'extended';
        }

        function updateResultsCount(count) {
            const totalVendors = vendors.length;
            if (count === totalVendors) {
                resultsCount.textContent = `Showing all ${count} vendors`;
            } else {
                resultsCount.textContent = `Showing ${count} of ${totalVendors} vendors`;
            }
        }

        function updateActiveFilters() {
            activeFilters.innerHTML = '';
            
            Object.entries(currentFilters).forEach(([key, value]) => {
                if (value) {
                    const filterName = getFilterDisplayName(key, value);
                    const activeFilter = document.createElement('div');
                    activeFilter.className = 'active-filter';
                    activeFilter.innerHTML = `
                        ${filterName}
                        <button class="remove-filter" onclick="removeFilter('${key}')" aria-label="Remove ${filterName} filter">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    activeFilters.appendChild(activeFilter);
                }
            });
        }

        function getFilterDisplayName(filterKey, filterValue) {
            const filterNames = {
                search: `Search: "${filterValue}"`,
                cuisine: `Cuisine: ${filterValue.charAt(0).toUpperCase() + filterValue.slice(1)}`,
                price: `Price: ${getPriceDisplayName(filterValue)}`,
                rating: `Rating: ${filterValue}+ stars`,
                delivery: `Delivery: ${getDeliveryDisplayName(filterValue)}`
            };
            
            return filterNames[filterKey] || `${filterKey}: ${filterValue}`;
        }

        function getPriceDisplayName(priceValue) {
            const priceNames = {
                'budget': 'Budget',
                'moderate': 'Moderate',
                'premium': 'Premium'
            };
            return priceNames[priceValue] || priceValue;
        }

        function getDeliveryDisplayName(deliveryValue) {
            const deliveryNames = {
                'fast': 'Fast (<30 min)',
                'standard': 'Standard (30-45 min)',
                'extended': 'Extended (>45 min)'
            };
            return deliveryNames[deliveryValue] || deliveryValue;
        }

        function removeFilter(filterKey) {
            currentFilters[filterKey] = '';
            
            // Reset the corresponding form element
            switch (filterKey) {
                case 'search':
                    searchInput.value = '';
                    break;
                case 'cuisine':
                    cuisineFilter.value = '';
                    break;
                case 'price':
                    priceFilter.value = '';
                    break;
                case 'rating':
                    ratingFilter.value = '';
                    break;
                case 'delivery':
                    deliveryFilter.value = '';
                    break;
            }
            
            applySearchAndFilter();
        }

        function resetSearchAndFilter() {
            // Reset all filters
            currentFilters = {
                search: '',
                cuisine: '',
                price: '',
                rating: '',
                delivery: ''
            };
            
            // Reset form elements
            searchInput.value = '';
            cuisineFilter.value = '';
            priceFilter.value = '';
            ratingFilter.value = '';
            deliveryFilter.value = '';
            sortOptions.value = 'name';
            
            // Reapply filters (which will show all vendors)
            applySearchAndFilter();
        }

        // ===== ACCESSIBILITY: ENHANCE KEYBOARD NAVIGATION =====
        function enhanceKeyboardNavigation() {
            // Add keyboard navigation to modal triggers
            document.addEventListener('keydown', function(e) {
                // Close modals with Escape key
                if (e.key === 'Escape') {
                    closeAllModals();
                    protectedOverlay.style.display = 'none';
                    closeCheckout();
                    
                    const toast = document.querySelector('.toast');
                    if (toast) toast.remove();
                    
                    // Close cart modal if open
                    const cartModal = document.querySelector('.auth-modal:not(#loginModal):not(#signupModal):not(#checkoutModal)');
                    const cartOverlay = document.querySelector('.overlay:not(#overlay)');
                    
                    if (cartModal) cartModal.remove();
                    if (cartOverlay) cartOverlay.remove();
                }
                
                // Navigate modals with arrow keys
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    const activeElement = document.activeElement;
                    const focusableElements = getFocusableElements(activeElement.closest('.auth-modal, .checkout-modal'));
                    
                    if (focusableElements.length > 0) {
                        e.preventDefault();
                        const currentIndex = focusableElements.indexOf(activeElement);
                        let nextIndex;
                        
                        if (e.key === 'ArrowDown') {
                            nextIndex = currentIndex < focusableElements.length - 1 ? currentIndex + 1 : 0;
                        } else {
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableElements.length - 1;
                        }
                        
                        focusableElements[nextIndex].focus();
                    }
                }
            });
        }

        function getFocusableElements(container) {
            if (!container) return [];
            return Array.from(container.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            )).filter(el => !el.disabled && el.offsetParent !== null);
        }

        // Setup header scroll behavior
        function setupHeaderScroll() {
            const header = document.querySelector('header');
            const headerContent = document.querySelector('.header-content');
            
            window.addEventListener('scroll', debounce(() => {
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                    headerContent.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                    headerContent.classList.remove('scrolled');
                }
            }, 10));
        }

        // Setup auth enhancements
        function setupAuthEnhancements() {
            // Password toggle functionality
            setupPasswordToggle('loginPassword', 'loginPasswordToggle');
            setupPasswordToggle('signupPassword', 'signupPasswordToggle');
            
            // Form validation
            setupFormValidation();
        }

        // Setup password toggle
        function setupPasswordToggle(passwordFieldId, toggleButtonId) {
            const passwordField = document.getElementById(passwordFieldId);
            const toggleButton = document.getElementById(toggleButtonId);
            
            if (passwordField && toggleButton) {
                toggleButton.addEventListener('click', function() {
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        toggleButton.setAttribute('aria-label', 'Hide password');
                    } else {
                        passwordField.type = 'password';
                        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
                        toggleButton.setAttribute('aria-label', 'Show password');
                    }
                });

                // Add keyboard support for password toggle
                toggleButton.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleButton.click();
                    }
                });
            }
        }

        // Setup form validation
        function setupFormValidation() {
            // Login form validation
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail) {
                loginEmail.addEventListener('blur', function() {
                    validateEmail(this, 'loginEmailError');
                });
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('blur', function() {
                    validateField(this, 'loginPasswordError', 'Please enter your password');
                });
            }
            
            // Signup form validation
            const signupName = document.getElementById('signupName');
            const signupEmail = document.getElementById('signupEmail');
            const signupPassword = document.getElementById('signupPassword');
            
            if (signupName) {
                signupName.addEventListener('blur', function() {
                    validateField(this, 'signupNameError', 'Please enter your full name');
                });
            }
            
            if (signupEmail) {
                signupEmail.addEventListener('blur', function() {
                    validateEmail(this, 'signupEmailError');
                });
            }
            
            if (signupPassword) {
                signupPassword.addEventListener('blur', function() {
                    validatePassword(this, 'signupPasswordError');
                });
            }
            
            // Forgot password validation
            const resetEmail = document.getElementById('resetEmail');
            
            if (resetEmail) {
                resetEmail.addEventListener('blur', function() {
                    validateEmail(this, 'resetEmailError');
                });
            }
        }

        // Validate email field
        function validateEmail(field, errorId) {
            const errorElement = document.getElementById(errorId);
            const parent = field.closest('.form-input-group');
            
            if (!field.value || !/\S+@\S+\.\S+/.test(field.value)) {
                parent.classList.add('error');
                errorElement.textContent = 'Please enter a valid email address';
                return false;
            } else {
                parent.classList.remove('error');
                return true;
            }
        }

        // Validate required field
        function validateField(field, errorId, errorMessage) {
            const errorElement = document.getElementById(errorId);
            const parent = field.closest('.form-input-group');
            
            if (!field.value.trim()) {
                parent.classList.add('error');
                errorElement.textContent = errorMessage;
                return false;
            } else {
                parent.classList.remove('error');
                return true;
            }
        }

        // Validate password field
        function validatePassword(field, errorId) {
            const errorElement = document.getElementById(errorId);
            const parent = field.closest('.form-input-group');
            
            if (!field.value || field.value.length < 8) {
                parent.classList.add('error');
                errorElement.textContent = 'Password must be at least 8 characters';
                return false;
            } else {
                parent.classList.remove('error');
                return true;
            }
        }

        // Load vendors from localStorage
        function loadVendors() {
            try {
                const savedVendors = localStorage.getItem('vendors');
                if (savedVendors) {
                    vendors = JSON.parse(savedVendors);
                    // Clear existing vendors to start fresh
                    if (vendors.length > 0) {
                        vendors = [];
                        saveVendors();
                    }
                    renderVendors();
                } else {
                    // Start with empty vendors array
                    vendors = [];
                    saveVendors();
                    renderVendors();
                }
            } catch (error) {
                console.error("Error loading vendors:", error);
                showToast("Error loading vendors", true);
                // Start with empty vendors array as fallback
                vendors = [];
                renderVendors();
            }
        }

        // Save vendors to localStorage
        function saveVendors() {
            try {
                localStorage.setItem('vendors', JSON.stringify(vendors));
            } catch (error) {
                console.error("Error saving vendors:", error);
                showToast("Error saving vendor data", true);
            }
        }

        // Render vendors to the page
        function renderVendors() {
            applySearchAndFilter(); // This will render the filtered and sorted vendors
        }

        // Load cart from localStorage on page load
        function loadCart() {
            try {
                const savedCart = sessionStorage.getItem('cart');
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    updateCartCount();
                }
            } catch (error) {
                console.error("Error loading cart:", error);
                showToast("Error loading cart", true);
            }
        }

        // Save cart to localStorage
        function saveCart() {
            try {
                sessionStorage.setItem('cart', JSON.stringify(cart));
            } catch (error) {
                console.error("Error saving cart:", error);
                showToast("Error saving cart", true);
            }
        }

        // Check background color for social icons
        function checkBackgroundColor() {
            try {
                const heroSection = document.querySelector('.hero');
                const socialIcons = document.querySelector('.social-icons');
                
                if (!heroSection || !socialIcons) return;
                
                // Get position of social icons
                const rect = socialIcons.getBoundingClientRect();
                const centerY = rect.top + (rect.height / 2);
                
                // Get element at that position
                const elementAtCenter = document.elementFromPoint(rect.left + (rect.width / 2), centerY);
                
                // Check if it's the hero section (dark background)
                if (elementAtCenter === heroSection || heroSection.contains(elementAtCenter)) {
                    document.body.classList.add('dark-bg');
                } else {
                    document.body.classList.remove('dark-bg');
                }
            } catch (error) {
                console.error("Error checking background color:", error);
            }
        }

        // Toggle vendor fields visibility
        function toggleVendorFields() {
            try {
                const userType = document.getElementById('userType').value;
                const vendorFields = document.getElementById('vendorFields');
                
                if (userType === 'seller') {
                    vendorFields.style.display = 'flex';
                    vendorFields.setAttribute('aria-hidden', 'false');
                } else {
                    vendorFields.style.display = 'none';
                    vendorFields.setAttribute('aria-hidden', 'true');
                }
            } catch (error) {
                console.error("Error toggling vendor fields:", error);
                showToast("Error updating form", true);
            }
        }

        // Preview uploaded images
        function previewImage(input, previewId) {
            const previewContainer = document.getElementById(previewId);
            previewContainer.innerHTML = '';
            
            if (input.files) {
                const files = input.files;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = `Preview image ${i + 1}`;
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.setAttribute('aria-label', 'Remove image');
                        removeBtn.onclick = function() {
                            previewItem.remove();
                            // Clear the file input
                            input.value = '';
                        };
                        
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        previewContainer.appendChild(previewItem);
                    }
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        // Show restaurant detail page
        function showRestaurantDetail(restaurantId) {
            try {
                const restaurant = vendors.find(v => v.id === restaurantId);
                if (!restaurant) {
                    showToast("Restaurant not found", true);
                    return;
                }
                
                // Hide home page, show detail page
                homePage.style.display = 'none';
                restaurantDetailPage.style.display = 'block';
                restaurantDetailPage.setAttribute('aria-hidden', 'false');
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                // Generate restaurant detail HTML
                let detailHTML = `
                    <a href="#" class="back-button" onclick="goBackToHome(); return false;" aria-label="Go back to vendors list">
                        <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to Vendors
                    </a>
                    
                    <div class="restaurant-header">
                        <div class="restaurant-hero">
                            <img src="${restaurant.photos && restaurant.photos.length > 0 ? restaurant.photos[0] : 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1600&q=80'}" alt="${restaurant.businessName}">
                        </div>
                        
                        <div class="restaurant-info">
                            <div class="restaurant-title">
                                <h1>${restaurant.businessName}</h1>
                                <span class="vendor-badge">${restaurant.businessType || 'Food Vendor'}</span>
                            </div>
                            
                            <div class="restaurant-meta">
                                <div class="meta-item">
                                    <i class="fas fa-star" aria-hidden="true"></i>
                                    <span>${restaurant.rating || 4.0} (${restaurant.reviewCount || 0} reviews)</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                    <span>${restaurant.businessLocation || 'Nairobi, Kenya'}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock" aria-hidden="true"></i>
                                    <span>${restaurant.deliveryTime || 45} min</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-truck" aria-hidden="true"></i>
                                    <span>Delivery: KSh 100</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-shopping-bag" aria-hidden="true"></i>
                                    <span>Min order: KSh ${restaurant.minPrice || 300}</span>
                                </div>
                            </div>
                            
                            <div class="restaurant-description">
                                <p>${restaurant.description || 'Delicious food made with love and tradition.'}</p>
                            </div>
                            
                            <div class="restaurant-actions">
                                <button class="btn" onclick="showToast('Restaurant added to favorites!')" aria-label="Add restaurant to favorites">
                                    <i class="far fa-heart" aria-hidden="true"></i> Add to Favorites
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="menu-section">
                        <h2>Menu</h2>
                        <div class="empty-state">
                            <i class="fas fa-utensils" aria-hidden="true"></i>
                            <h3>Menu Coming Soon</h3>
                            <p>This vendor is still setting up their menu. Check back later!</p>
                        </div>
                    </div>
                    
                    <div class="reviews-section">
                        <h2>Customer Reviews</h2>
                        <div class="empty-state">
                            <i class="fas fa-comments" aria-hidden="true"></i>
                            <h3>No Reviews Yet</h3>
                            <p>Be the first to review this vendor!</p>
                        </div>
                    </div>
                `;
                
                // Set the HTML content
                restaurantDetailPage.innerHTML = detailHTML;
            } catch (error) {
                console.error("Error showing restaurant detail:", error);
                showToast("Error loading restaurant details", true);
            }
        }

        // Go back to home page
        function goBackToHome() {
            homePage.style.display = 'block';
            restaurantDetailPage.style.display = 'none';
            restaurantDetailPage.setAttribute('aria-hidden', 'true');
            window.scrollTo(0, 0);
        }

        // Show login modal
        function showLoginModal() {
            try {
                closeAllModals();
                overlay.style.display = 'block';
                loginModal.style.display = 'block';
                loginModal.setAttribute('aria-hidden', 'false');
                protectedOverlay.style.display = 'none';
                document.getElementById('loginEmail').focus();
            } catch (error) {
                console.error("Error showing login modal:", error);
                showToast("Error opening login form", true);
            }
        }

        // Show signup modal
        function showSignupModal() {
            try {
                closeAllModals();
                overlay.style.display = 'block';
                signupModal.style.display = 'block';
                signupModal.setAttribute('aria-hidden', 'false');
                protectedOverlay.style.display = 'none';
                document.getElementById('signupName').focus();
            } catch (error) {
                console.error("Error showing signup modal:", error);
                showToast("Error opening signup form", true);
            }
        }

        // Show forgot password modal
        function showForgotPassword() {
            try {
                closeAllModals();
                overlay.style.display = 'block';
                forgotPasswordModal.style.display = 'block';
                forgotPasswordModal.setAttribute('aria-hidden', 'false');
                document.getElementById('resetEmail').focus();
            } catch (error) {
                console.error("Error showing forgot password modal:", error);
                showToast("Error opening password reset form", true);
            }
        }

        // UPDATED: Close all modals to include contact modal
        function closeAllModals() {
            try {
                overlay.style.display = 'none';
                loginModal.style.display = 'none';
                loginModal.setAttribute('aria-hidden', 'true');
                signupModal.style.display = 'none';
                signupModal.setAttribute('aria-hidden', 'true');
                forgotPasswordModal.style.display = 'none';
                forgotPasswordModal.setAttribute('aria-hidden', 'true');
                checkoutModal.style.display = 'none';
                checkoutModal.setAttribute('aria-hidden', 'true');
                document.getElementById('contactModal').style.display = 'none';
                document.getElementById('contactModal').setAttribute('aria-hidden', 'true');
            } catch (error) {
                console.error("Error closing modals:", error);
            }
        }

        // Switch to signup form
        function switchToSignup() {
            try {
                loginModal.style.display = 'none';
                forgotPasswordModal.style.display = 'none';
                signupModal.style.display = 'block';
                signupModal.setAttribute('aria-hidden', 'false');
                document.getElementById('signupName').focus();
            } catch (error) {
                console.error("Error switching to signup:", error);
                showToast("Error switching forms", true);
            }
        }

        // Switch to login form
        function switchToLogin() {
            try {
                signupModal.style.display = 'none';
                forgotPasswordModal.style.display = 'none';
                loginModal.style.display = 'block';
                loginModal.setAttribute('aria-hidden', 'false');
                document.getElementById('loginEmail').focus();
            } catch (error) {
                console.error("Error switching to login:", error);
                showToast("Error switching forms", true);
            }
        }

        // Performance optimization: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Preload critical images
        function preloadCriticalImages() {
            const criticalImages = [
                'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1600&q=80'
            ];
            
            criticalImages.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        // ===== USER EXPERIENCE: ENHANCED LOADING STATES =====
        function showLoadingState(button, text = 'Processing...') {
            const originalText = button.innerHTML;
            button.innerHTML = `<span class="loading"></span> ${text}`;
            button.classList.add('loading');
            button.disabled = true;
            return originalText;
        }

        function hideLoadingState(button, originalText) {
            button.innerHTML = originalText;
            button.classList.remove('loading');
            button.disabled = false;
        }

        // Login function
        function handleLogin() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                // Validate form
                const isEmailValid = validateEmail(document.getElementById('loginEmail'), 'loginEmailError');
                const isPasswordValid = validateField(document.getElementById('loginPassword'), 'loginPasswordError', 'Please enter your password');
                
                if (!isEmailValid || !isPasswordValid) {
                    showToast("Please fix the errors in the form", true);
                    return;
                }

                // Show enhanced loading state
                const loginButton = document.getElementById('loginButton');
                const originalText = showLoadingState(loginButton, 'Signing in...');
                
                showToast("Logging in...");
                
                // Use Firebase login
                firebaseAuth.login(email, password).then(result => {
                    if (result.success) {
                        showToast("Login successful!", false, 'success');
                        isLoggedIn = true;
                        currentUser = result.user;
                        closeAllModals();
                        
                        // If remember me is checked, store in localStorage
                        if (rememberMe) {
                            localStorage.setItem('rememberedEmail', email);
                        }
                    } else {
                        showToast(result.error, true);
                    }
                    
                    // Remove loading state
                    hideLoadingState(loginButton, originalText);
                }).catch(error => {
                    showToast("An unexpected error occurred", true);
                    hideLoadingState(loginButton, originalText);
                });
            } catch (error) {
                console.error("Login error:", error);
                showToast("An unexpected error occurred", true);
                
                // Remove loading state
                const loginButton = document.getElementById('loginButton');
                if (loginButton) {
                    hideLoadingState(loginButton, 'Login');
                }
            }
        }

        // Signup function
        function handleSignup() {
            try {
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const userType = document.getElementById('userType').value;
                const termsAgreed = document.getElementById('termsAgree').checked;

                // Validate form
                const isNameValid = validateField(document.getElementById('signupName'), 'signupNameError', 'Please enter your full name');
                const isEmailValid = validateEmail(document.getElementById('signupEmail'), 'signupEmailError');
                const isPasswordValid = validatePassword(document.getElementById('signupPassword'), 'signupPasswordError');
                
                if (!isNameValid || !isEmailValid || !isPasswordValid) {
                    showToast("Please fix the errors in the form", true);
                    return;
                }
                
                if (!termsAgreed) {
                    showToast("Please agree to the Terms of Service and Privacy Policy", true);
                    return;
                }

                // Additional validation for sellers
                if (userType === 'seller') {
                    const businessName = document.getElementById('businessName').value;
                    const businessLocation = document.getElementById('businessLocation').value;
                    const foodHandlersCert = document.getElementById('foodHandlersCert').value;
                    
                    if (!businessName || !businessLocation || !foodHandlersCert) {
                        showToast("As a seller, please provide your business details for verification", true);
                        return;
                    }
                }

                // Show enhanced loading state
                const signupButton = document.getElementById('signupButton');
                const originalText = showLoadingState(signupButton, 'Creating account...');
                
                showToast("Creating account...");
                
                // Prepare user data
                const userData = {
                    name: name,
                    userType: userType
                };
                
                // Add vendor-specific data if seller
                if (userType === 'seller') {
                    userData.businessName = document.getElementById('businessName').value;
                    userData.businessLocation = document.getElementById('businessLocation').value;
                    userData.description = document.getElementById('description').value;
                    userData.businessType = document.getElementById('deliveryMethod') ? document.getElementById('deliveryMethod').value : 'Food Vendor';
                }
                
                // Use Firebase signup
                firebaseAuth.signup(email, password, userData).then(result => {
                    if (result.success) {
                        if (userType === 'seller') {
                            showToast("Account created! Seller verification pending.", false, 'success');
                        } else {
                            showToast("Account created successfully!", false, 'success');
                        }
                        isLoggedIn = true;
                        currentUser = result.user;
                        closeAllModals();
                    } else {
                        showToast(result.error, true);
                    }
                    
                    // Remove loading state
                    hideLoadingState(signupButton, originalText);
                }).catch(error => {
                    showToast("An unexpected error occurred", true);
                    hideLoadingState(signupButton, originalText);
                });
            } catch (error) {
                console.error("Signup error:", error);
                showToast("An unexpected error occurred", true);
                
                // Remove loading state
                const signupButton = document.getElementById('signupButton');
                if (signupButton) {
                    hideLoadingState(signupButton, 'Create Account');
                }
            }
        }

        // Reset password function
        function resetPassword() {
            try {
                const email = document.getElementById('resetEmail').value;
                
                // Validate email
                const isEmailValid = validateEmail(document.getElementById('resetEmail'), 'resetEmailError');
                
                if (!isEmailValid) {
                    showToast("Please enter a valid email address", true);
                    return;
                }

                // Show enhanced loading state
                const resetButton = document.getElementById('resetPasswordButton');
                const originalText = showLoadingState(resetButton, 'Sending...');
                
                showToast("Sending reset instructions...");
                
                // Use Firebase password reset
                auth.sendPasswordResetEmail(email).then(() => {
                    closeAllModals();
                    showToast("Password reset instructions sent to your email", false, 'success');
                    hideLoadingState(resetButton, originalText);
                }).catch(error => {
                    showToast("Error sending reset email: " + error.message, true);
                    hideLoadingState(resetButton, originalText);
                });
            } catch (error) {
                console.error("Reset password error:", error);
                showToast("An unexpected error occurred", true);
                
                // Remove loading state
                const resetButton = document.getElementById('resetPasswordButton');
                if (resetButton) {
                    hideLoadingState(resetButton, 'Send Reset Link');
                }
            }
        }

        // Google sign-in
        function signInWithGoogle() {
            try {
                showToast("Google sign-in not yet implemented", true);
            } catch (error) {
                console.error("Google sign-in error:", error);
                showToast("An unexpected error occurred", true);
            }
        }

        // Facebook sign-in
        function signInWithFacebook() {
            try {
                showToast("Facebook sign-in not yet implemented", true);
            } catch (error) {
                console.error("Facebook sign-in error:", error);
                showToast("An unexpected error occurred", true);
            }
        }

        // Add to cart function
        function addToCart(itemName, itemPrice) {
            try {
                if (!isLoggedIn) {
                    protectedOverlay.style.display = 'flex';
                    return;
                }

                cart.push({
                    name: itemName,
                    price: itemPrice,
                    id: Date.now().toString()
                });
                updateCartCount();
                saveCart();
                
                showToast(`${itemName} added to cart!`, false, 'success');
            } catch (error) {
                console.error("Add to cart error:", error);
                showToast("Error adding item to cart", true);
            }
        }

        // Remove from cart function
        function removeFromCart(itemId) {
            try {
                cart = cart.filter(item => item.id !== itemId);
                updateCartCount();
                saveCart();
                showToast("Item removed from cart");
            } catch (error) {
                console.error("Remove from cart error:", error);
                showToast("Error removing item from cart", true);
            }
        }

        // Update cart count
        function updateCartCount() {
            try {
                cartCount.textContent = cart.length;
                cartCount.style.display = cart.length > 0 ? 'flex' : 'none';
            } catch (error) {
                console.error("Update cart count error:", error);
            }
        }

        // Show cart
        function showCart() {
            try {
                if (!isLoggedIn) {
                    protectedOverlay.style.display = 'flex';
                    return;
                }

                if (cart.length === 0) {
                    showToast("Your cart is empty!");
                    return;
                }

                // Create cart modal
                const cartModal = document.createElement('div');
                cartModal.className = 'auth-modal';
                cartModal.style.display = 'block';
                cartModal.setAttribute('aria-modal', 'true');
                cartModal.setAttribute('role', 'dialog');
                cartModal.setAttribute('aria-labelledby', 'cart-heading');
                
                let cartContent = `
                    <span class="close" onclick="this.parentElement.remove(); document.querySelector('.overlay:not(#overlay)').remove()" aria-label="Close cart">×</span>
                    <h2 id="cart-heading">Your Cart</h2>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                `;
                
                let total = 0;
                
                cart.forEach(item => {
                    cartContent += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee;">
                            <div>
                                <h3 style="margin: 0 0 5px; font-size: 1.1rem;">${item.name}</h3>
                                <p style="margin: 0; color: #666;">KSh ${item.price}</p>
                            </div>
                            <button onclick="removeFromCart('${item.id}')" style="background: var(--accent); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" aria-label="Remove ${item.name} from cart">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    total += item.price;
                });

                cartContent += `
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.2rem; padding: 10px 0; border-top: 2px solid var(--secondary);">
                        <span>Total:</span>
                        <span>KSh ${total}</span>
                    </div>
                    <button onclick="showCheckout()" class="btn" style="margin-top: 20px;" aria-label="Proceed to checkout">Proceed to Checkout</button>
                `;
                
                cartModal.innerHTML = cartContent;
                document.body.appendChild(cartModal);
                
                // Add overlay
                const cartOverlay = document.createElement('div');
                cartOverlay.className = 'overlay';
                cartOverlay.style.display = 'block';
                cartOverlay.onclick = () => {
                    cartModal.remove();
                    cartOverlay.remove();
                };
                document.body.appendChild(cartOverlay);

                // Focus management for accessibility
                setTimeout(() => {
                    cartModal.querySelector('.close').focus();
                }, 100);
            } catch (error) {
                console.error("Show cart error:", error);
                showToast("Error displaying cart", true);
            }
        }

        // Show checkout modal
        function showCheckout() {
            try {
                // Close cart modal first
                document.querySelector('.auth-modal').remove();
                document.querySelector('.overlay').remove();
                
                // Calculate total
                let total = 0;
                let itemsHTML = '';
                
                cart.forEach(item => {
                    itemsHTML += `
                        <div class="checkout-item">
                            <span>${item.name}</span>
                            <span>KSh ${item.price}</span>
                        </div>
                    `;
                    total += item.price;
                });
                
                // Update checkout items and total
                checkoutItems.innerHTML = itemsHTML;
                checkoutTotal.textContent = `KSh ${total}`;
                
                // Show checkout modal
                overlay.style.display = 'block';
                checkoutModal.style.display = 'block';
                checkoutModal.setAttribute('aria-hidden', 'false');

                // Focus management for accessibility
                setTimeout(() => {
                    checkoutModal.querySelector('.close').focus();
                }, 100);
            } catch (error) {
                console.error("Show checkout error:", error);
                showToast("Error loading checkout", true);
            }
        }

        // Close checkout modal
        function closeCheckout() {
            checkoutModal.style.display = 'none';
            checkoutModal.setAttribute('aria-hidden', 'true');
            overlay.style.display = 'none';
        }

        // Select payment method
        function selectPayment(method) {
            selectedPaymentMethod = method;
            
            // Remove active class from all options
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
                option.setAttribute('aria-selected', 'false');
            });
            
            // Add active class to selected option
            const selectedOption = event.target.closest('.payment-option');
            selectedOption.classList.add('active');
            selectedOption.setAttribute('aria-selected', 'true');
            
            // Show appropriate form
            document.getElementById('mpesaForm').style.display = method === 'mpesa' ? 'block' : 'none';
            document.getElementById('cashForm').style.display = method === 'cash' ? 'block' : 'none';
        }

        // Pay with M-Pesa
        function payWithMpesa() {
            const phone = document.getElementById('mpesaPhoneCheckout').value;
            
            if (!phone) {
                showToast("Please enter your phone number", true);
                return;
            }
            
            showToast("Sending M-Pesa request...");
            
            // Simulate M-Pesa payment
            setTimeout(() => {
                closeCheckout();
                placeOrder();
                showToast("Payment successful! Order placed.", false, 'success');
            }, 2000);
        }

        // Place order (for cash payment)
        function placeOrder() {
            showToast("Order placed successfully!", false, 'success');
            
            // Clear cart
            cart = [];
            updateCartCount();
            saveCart();
            
            // Close checkout modal
            closeCheckout();
        }

        // Show toast notification
        function showToast(message, isError = false, type = 'default') {
            try {
                // Remove existing toasts
                const existingToast = document.querySelector('.toast');
                if (existingToast) existingToast.remove();
                
                const toast = document.createElement('div');
                toast.className = `toast ${isError ? 'error' : type === 'success' ? 'success' : ''}`;
                toast.textContent = message;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'polite');
                document.body.appendChild(toast);
                
                // Show the toast
                toast.style.display = 'block';
                
                // Auto-remove after animation
                setTimeout(() => {
                    toast.remove();
                }, 4000);
            } catch (error) {
                console.error("Toast error:", error);
            }
        }

        // Close modals when clicking overlay
        overlay.addEventListener('click', closeAllModals);
        protectedOverlay.addEventListener('click', () => {
            protectedOverlay.style.display = 'none';
        });

        // Prevent modal close when clicking inside modal
        loginModal.addEventListener('click', (e) => e.stopPropagation());
        signupModal.addEventListener('click', (e) => e.stopPropagation());
        forgotPasswordModal.addEventListener('click', (e) => e.stopPropagation());
        checkoutModal.addEventListener('click', (e) => e.stopPropagation());
        document.getElementById('contactModal').addEventListener('click', (e) => e.stopPropagation());

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            init();
            
            // Check if there's a remembered email
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('loginEmail').value = rememberedEmail;
                document.getElementById('rememberMe').checked = true;
            }
        });

        window.addEventListener('resize', debounce(checkBackgroundColor, 100));
        window.addEventListener('scroll', debounce(checkBackgroundColor, 100));
    </script>
</body>
</html>
